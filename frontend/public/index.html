<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" href="%PUBLIC_URL%/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#000000" />
    <meta
      name="description"
      content="Tablero de Control - Sistema de Gesti√≥n"
    />
    <link rel="apple-touch-icon" href="%PUBLIC_URL%/logo192.png" />
    <link rel="manifest" href="%PUBLIC_URL%/manifest.json" />
    <title>Tablero de Control</title>
    
    <!-- Script de control de versiones y cache busting -->
    <script>
      // Versi√≥n de la aplicaci√≥n para cache busting
      window.APP_VERSION = '4.0.0-' + Date.now();
      
      // Detectar si viene de limpieza nuclear o emergencia
      const urlParams = new URLSearchParams(window.location.search);
      const isNuclear = urlParams.get('nuclear') === 'true';
      const isDirect = urlParams.get('direct') === 'true';
      const isEmergency = urlParams.get('emergency') === 'true';
      const isClean = urlParams.get('clean') === 'true';
      const isForce = urlParams.get('force') === 'true';
      const isReload = urlParams.get('reload') === 'true';
      const isCache = urlParams.get('cache') === 'true';
      
      // Detectar si la URL contiene palabras clave de limpieza
      const currentPath = window.location.pathname;
      const isForceReload = currentPath.includes('force-reload') || currentPath.includes('cache-clear');
      
      if (isNuclear || isDirect || isEmergency || isClean || isForce || isReload || isCache || isForceReload) {
        console.log('üö® DETECTADA LIMPIEZA - Forzando URLs correctas');
        
        // Mostrar p√°gina de limpieza inmediatamente
        document.body.innerHTML = `
          <div style="
            font-family: Arial, sans-serif; 
            background: linear-gradient(45deg, #ff0000, #ff6600);
            color: white;
            text-align: center;
            padding: 50px;
            margin: 0;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
          ">
            <div style="
              background: rgba(0,0,0,0.8); 
              padding: 30px; 
              border-radius: 15px;
              max-width: 600px;
            ">
              <h1>üßπ LIMPIANDO CACHE</h1>
              <p>Limpiando todo el cache del navegador...</p>
              <div id="status" style="margin: 20px 0; font-size: 16px;">Iniciando limpieza...</div>
              <button onclick="limpiarTodo()" style="
                background: #00ff00;
                color: black;
                border: none;
                padding: 20px 40px;
                font-size: 20px;
                border-radius: 8px;
                cursor: pointer;
                margin: 10px;
                font-weight: bold;
              ">LIMPIAR AHORA</button>
            </div>
          </div>
        `;
        
        // Funci√≥n de limpieza
        window.limpiarTodo = function() {
          const status = document.getElementById('status');
          status.innerHTML = 'Limpiando localStorage...';
          
          try {
            localStorage.clear();
            status.innerHTML = 'Limpiando sessionStorage...';
            sessionStorage.clear();
            
            status.innerHTML = 'Limpiando cache del navegador...';
            if ('caches' in window) {
              caches.keys().then(names => {
                names.forEach(name => caches.delete(name));
              });
            }
            
            status.innerHTML = 'Desregistrando service workers...';
            if ('serviceWorker' in navigator) {
              navigator.serviceWorker.getRegistrations().then(registrations => {
                registrations.forEach(registration => registration.unregister());
              });
            }
            
            status.innerHTML = 'Redirigiendo al login...';
            
            setTimeout(() => {
              const timestamp = Date.now();
              window.location.href = '/?v=' + timestamp + '&clean=true&final=' + timestamp;
            }, 1000);
            
          } catch(e) {
            status.innerHTML = 'Error: ' + e.message;
          }
        };
        
        // Auto-activar limpieza
        setTimeout(() => {
          if (window.limpiarTodo) {
            window.limpiarTodo();
          }
        }, 2000);
        
        // No cargar React si estamos en modo limpieza
        throw new Error('MODO LIMPIEZA ACTIVADO');
      }
      
      // Limpiar cualquier cache residual
      if ('caches' in window) {
        caches.keys().then(names => {
          names.forEach(name => caches.delete(name));
        });
      }
      
      // Interceptar todas las llamadas fetch para reemplazar localhost
      const originalFetch = window.fetch;
      window.fetch = function(url, options) {
        let modifiedUrl = url;
        
        // Si es una URL localhost, reemplazarla con la URL de producci√≥n
        if (typeof url === 'string' && url.includes('localhost:5001')) {
          modifiedUrl = url.replace('http://localhost:5001', 'https://tablero-control-1.onrender.com');
          console.log('üîÑ Interceptando fetch:', url, '‚Üí', modifiedUrl);
        }
        
        return originalFetch(modifiedUrl, options);
      };
      
      // Interceptar XMLHttpRequest tambi√©n
      const originalXHROpen = XMLHttpRequest.prototype.open;
      XMLHttpRequest.prototype.open = function(method, url, ...args) {
        let modifiedUrl = url;
        
        if (typeof url === 'string' && url.includes('localhost:5001')) {
          modifiedUrl = url.replace('http://localhost:5001', 'https://tablero-control-1.onrender.com');
          console.log('üîÑ Interceptando XHR:', url, '‚Üí', modifiedUrl);
        }
        
        return originalXHROpen.call(this, method, modifiedUrl, ...args);
      };
      
      // Forzar recarga de recursos est√°ticos con cache busting
      function forceReloadResources() {
        const timestamp = Date.now();
        const links = document.querySelectorAll('link[rel="stylesheet"]');
        const scripts = document.querySelectorAll('script[src]');
        
        links.forEach(link => {
          if (link.href && !link.href.includes('?v=')) {
            link.href = link.href + '?v=' + timestamp;
          }
        });
        
        scripts.forEach(script => {
          if (script.src && !script.src.includes('?v=')) {
            script.src = script.src + '?v=' + timestamp;
          }
        });
      }
      
      // Ejecutar cuando el DOM est√© listo
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', forceReloadResources);
      } else {
        forceReloadResources();
      }
    </script>
  </head>
  <body>
    <noscript>Necesitas habilitar JavaScript para ejecutar esta aplicaci√≥n.</noscript>
    <div id="root"></div>
  </body>
</html>
